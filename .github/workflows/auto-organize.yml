name: Auto Organize Repository

on:
  push:
    branches:
      - main
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * 1'   # æ¯å‘¨ä¸€å‡Œæ™¨æ‰§è¡Œä¸€æ¬¡

permissions:
  contents: write
  pull-requests: write

jobs:
  organize:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up git identity
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Ensure directories exist
        run: |
          mkdir -p "music GitHub" "music list" mac vm win

      - name: Move non-music resource files to music GitHub
        run: |
          for f in $(find . -maxdepth 1 -type f ! -name "*.mp3" ! -name "*.m4a" ! -name "*.m3u" ! -name "README.md" ! -name "DIRECTORY.md" ! -name ".gitignore" ! -name ".gitattributes" ! -name ".htaccess" ! -name ".nojekyll" ! -name "_config.yml" ! -name "index.html" ! -name "*.yml"); do
            git mv "$f" "music GitHub/" 2>/dev/null || true
          done

      - name: Move mac scripts
        run: |
          find . -maxdepth 1 -type f -regex "./mac[-_].*" -exec git mv {} mac/ \; 2>/dev/null || true

      - name: Move vm scripts
        run: |
          find . -maxdepth 1 -type f -regex "./vm[-_].*" -exec git mv {} vm/ \; 2>/dev/null || true

      - name: Move win scripts
        run: |
          find . -maxdepth 1 -type f -regex "./win[-_].*" -exec git mv {} win/ \; 2>/dev/null || true

      - name: Do not move .m3u playlists (only ensure directory exists)
        run: |
          # Playlist directory only, manual decision to avoid breaking audio links
          echo "Keeping *.m3u files in root to protect streaming links"

      - name: Generate/Update DIRECTORY.md
        run: |
          cat << 'EOF' > DIRECTORY.md
          # Repository Directory Guide

          This repository hosts static music files for streaming via GitHub Pages.
          **Certain file types MUST NOT be moved**, or direct links will break.

          ## ğŸ“Œ Rules

          | File Type | Action | Reason |
          |-----------|--------|--------|
          | `.mp3`, `.m4a` | Stay in root | Streaming URL stability |
          | `.m3u` | Stay in root | Used as playlist links; moving breaks client references |
          | `mac_*, mac-*` | Move to `mac/` | macOS scripts |
          | `vm_*, vm-*` | Move to `vm/` | Virtual machine scripts |
          | `win_*, win-*` | Move to `win/` | Windows scripts |
          | Others (not media) | Move to `music GitHub/` | Not used by player |

          ## ğŸ“‚ Directory Structure

          - `music GitHub/` â†’ Maintenance & resource files (NOT audio)
          - `music list/` â†’ *(reserved, disabled for safety)*
          - `mac/` â†’ macOS scripts
          - `vm/` â†’ VM scripts
          - `win/` â†’ Windows scripts

          EOF

      - name: Check if changes were made
        run: |
          if git diff --cached --quiet; then
            echo "No changes detected. Exiting."
            exit 0
          fi

      - name: Commit changes
        run: |
          git commit -m "chore: auto-organize directory structure"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: auto-organize directory structure"
          title: "Auto-organized: Repository Maintenance"
          body: |
            ### ğŸ¤– è‡ªåŠ¨æ•´ç†å®Œæˆ

            æœ¬ Pull Request ç”± GitHub Actions è‡ªåŠ¨åˆ›å»ºã€‚

            #### ğŸ“Œ è§„åˆ™è¯´æ˜ï¼ˆä¸ä¼šç§»åŠ¨ `.mp3/.m4a/.m3u`ï¼‰
            - `.mp3/.m4a` **ä¿æŒåœ¨æ ¹ç›®å½•**ï¼ˆé¿å…ç›´é“¾å¤±æ•ˆï¼‰
            - `.m3u` **ä¿æŒåœ¨æ ¹ç›®å½•**ï¼ˆé¿å…æ­Œå•æ’­æ”¾å¤±æ•ˆï¼‰
            - `mac_*, mac-*` â†’ `mac/`
            - `vm_*, vm-*` â†’ `vm/`
            - `win_*, win-*` â†’ `win/`
            - å…¶ä»–ééŸ³é¢‘æ–‡ä»¶ â†’ `music GitHub/`

            è¯·å®¡æ ¸ååˆå¹¶ã€‚

          branch: auto-organize-script
