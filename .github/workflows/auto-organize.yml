name: Auto Organize Repository

on:
  push:
    branches:
      - main
  workflow_dispatch:
  schedule:
    # æ¯å‘¨ä¸€å‡Œæ™¨ 3 ç‚¹æ‰«æï¼ˆå¯è°ƒï¼‰
    - cron: '0 3 * * 1'

permissions:
  contents: write
  pull-requests: write

jobs:
  organize:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up git identity
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Organize directory structure
        run: |
          mkdir -p "music list" vm mac win "music GitHub"

          # Move .m3u playlists
          find . -maxdepth 1 -type f -name "*.m3u" -exec git mv {} "music list/" \;

          # Move vm* files
          find . -maxdepth 1 -type f -name "vm*" -exec git mv {} vm/ \;

          # Move mac* files
          find . -maxdepth 1 -type f -name "mac*" -exec git mv {} mac/ \;

          # Move win* files
          find . -maxdepth 1 -type f -name "win*" -exec git mv {} win/ \;

          # Move non-music, non-list files to music GitHub
          for f in $(find . -maxdepth 1 -type f ! -name "*.mp3" ! -name "*.m4a" ! -name "*.m3u" ! -name "README.md" ! -name "DIRECTORY.md" ! -name ".gitignore" ! -name ".gitattributes" ! -name "*.yml"); do
            git mv "$f" "music GitHub/" 2>/dev/null || true
          done

      - name: Check if changes were made
        run: |
          if git diff --cached --quiet; then
            echo "No changes detected. Exiting."
            exit 0
          fi

      - name: Commit changes
        run: |
          git commit -m "chore: auto-organize repository structure"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: auto-organize repository structure"
          title: "Auto-organized: Repository Maintenance"
          body: |
            ### ğŸ¤– è‡ªåŠ¨æ•´ç†å®Œæˆ
            æœ¬ Pull Request ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆã€‚
            æ ¹æ®è§„åˆ™é‡æ–°æ•´ç†äº†è„šæœ¬ä¸èµ„æºç›®å½•ï¼Œä¸å½±å“éŸ³é¢‘ç›´é“¾ã€‚

            #### ğŸ“¦ ç›®å½•è§„åˆ™
            - `.mp3/.m4a` â†’ ä¿æŒåœ¨æ ¹ç›®å½•ï¼ˆé¿å…ç›´é“¾å¤±æ•ˆï¼‰
            - `.m3u` â†’ `music list/`
            - `vm*` â†’ `vm/`
            - `mac*` â†’ `mac/`
            - `win*` â†’ `win/`
            - å…¶ä»–ééŸ³é¢‘æ‰˜ç®¡ç›¸å…³ â†’ `music GitHub/`

            è¯·æ£€æŸ¥æ— è¯¯ååˆå¹¶ã€‚

          branch: auto-organize-script
