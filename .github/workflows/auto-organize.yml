name: Auto Organize Repository

on:
  push:
    branches:
      - main
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * 1'

permissions:
  contents: write
  pull-requests: write

jobs:
  organize:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up git identity
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      # ğŸŸ¢ å®šä¹‰æ”¯æŒçš„è„šæœ¬ç±»å‹ï¼ˆä¿®å¤ç‰ˆï¼‰
      - name: Define script extensions
        run: |
          echo 'SCRIPT_EXTENSIONS=(\.(sh|bash|zsh|ksh|py|ps1|bat|cmd|rb|pl|php|lua|js|txt|conf|ini))$' >> $GITHUB_ENV

      # ğŸŸ¢ åˆ†ç±»è„šæœ¬æ–‡ä»¶
      - name: Move mac scripts
        run: |
          mkdir -p mac
          for f in $(ls | grep -E '^mac' | grep -E "$SCRIPT_EXTENSIONS"); do git mv "$f" mac/ 2>/dev/null || true; done

      - name: Move vm scripts
        run: |
          mkdir -p vm
          for f in $(ls | grep -E '^vm' | grep -E "$SCRIPT_EXTENSIONS"); do git mv "$f" vm/ 2>/dev/null || true; done

      - name: Move win scripts
        run: |
          mkdir -p win
          for f in $(ls | grep -E '^win' | grep -E "$SCRIPT_EXTENSIONS"); do git mv "$f" win/ 2>/dev/null || true; done

      # ğŸ›‘ éŸ³é¢‘æ–‡ä»¶å¿…é¡»ä¿ç•™æ ¹ç›®å½•
      - name: Protect streaming audio files
        run: echo "Keeping .mp3 .m4a .flac .m3u at root"

      # ğŸŸ¡ å…¶ä»–éè„šæœ¬ééŸ³é¢‘å½’æ¡£
      - name: Move other non-media files to archive
        run: |
          mkdir -p "music GitHub"
          for f in $(find . -maxdepth 1 -type f ! -name "*.mp3" ! -name "*.m4a" ! -name "*.flac" ! -name "*.m3u" ! -name "*.yml" ! -name "*.md" ! -name "README" ! -name "DIRECTORY.md" ! -name ".nojekyll" ! -name ".gitattributes" ! -name ".mime.types" ! -name ".htaccess" ! -name "_config.yml" ! -name "index.html"); do
            git mv "$f" "music GitHub/" 2>/dev/null || true
          done

      # ğŸ“„ è‡ªåŠ¨ç”Ÿæˆç›®å½•è¯´æ˜ï¼ˆä¿æŒä¸å˜ï¼‰
      - name: Generate/Update DIRECTORY.md
        run: |
          cat << 'EOF' > DIRECTORY.md
          # Repository Directory Guide

          ## ğŸµ Music Files (root)
          `.mp3`, `.m4a`, `.flac`, `.m3u` must remain at root to keep streaming links stable.

          ## ğŸ–¥ Script Files
          Scripts are auto-organized by OS prefix:

          | Prefix | Folder | Example |
          |--------|--------|---------|
          | `mac*` | `mac/` | mac_test.sh |
          | `vm*`  | `vm/`  | vm_setup.py |
          | `win*` | `win/` | win_clean.ps1 |

          ## ğŸ“¦ Archives
          `music GitHub/` contains misc. files (non-script/non-audio).

          EOF

      # âœ” æäº¤åˆ†ç±»æ”¹åŠ¨
      - name: Commit changes
        run: |
          if git diff --cached --quiet; then
            echo "No changes detected."; exit 0;
          fi
          git commit -m "chore: auto-organize directory structure"

      # ğŸ“¨ åˆ›å»ºå¯è‡ªåŠ¨åˆå¹¶çš„ PR
      - name: Create Auto-PR
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: auto-organize directory structure"
          title: "Auto-organized Repository Structure"
          body: "ğŸ¤– Automated update. Music safe. Scripts organized."
          branch: auto-organize-script
          labels: |
            automated
            automerge

      # ğŸ“Œ å®‰è£… GitHub CLI
      - name: Install GitHub CLI
        run: |
          sudo apt-get update >/dev/null
          sudo apt-get install -y gh >/dev/null

      # ğŸ” è‡ªåŠ¨åˆå¹¶ PRï¼ˆGitHub å®˜æ–¹ APIï¼‰
      - name: Enable Auto-Merge
        run: gh pr merge auto-organize-script --squash --auto
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
