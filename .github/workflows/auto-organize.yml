name: Auto Organize Repository

on:
  push:
    branches:
      - main
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * 1'   # æ¯å‘¨ä¸€å‡Œæ™¨æ•´ç†ä¸€æ¬¡

permissions:
  contents: write
  pull-requests: write

jobs:
  organize:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up git identity
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      # ğŸŸ¢ 1) å®šä¹‰è„šæœ¬æ‰©å±•åï¼ˆå¯æ‰©å±•ï¼‰
      - name: Define script extensions
        run: |
          echo "SCRIPT_EXTENSIONS=\(.sh|.bash|.zsh|.ksh|.py|.ps1|.bat|.cmd|.rb|.pl|.php|.lua|.js|.txt|.conf|.ini)$" >> $GITHUB_ENV

      # ğŸŸ¢ 2) å…ˆç§»åŠ¨è„šæœ¬ï¼ˆæŒ‰ mac/vm/win å‰ç¼€ï¼‰
      - name: Move mac scripts
        run: |
          mkdir -p mac
          for f in $(ls | grep -E '^mac.*' | grep -E "$SCRIPT_EXTENSIONS"); do
            git mv "$f" mac/ 2>/dev/null || true
          done

      - name: Move vm scripts
        run: |
          mkdir -p vm
          for f in $(ls | grep -E '^vm.*' | grep -E "$SCRIPT_EXTENSIONS"); do
            git mv "$f" vm/ 2>/dev/null || true
          done

      - name: Move win scripts
        run: |
          mkdir -p win
          for f in $(ls | grep -E '^win.*' | grep -E "$SCRIPT_EXTENSIONS"); do
            git mv "$f" win/ 2>/dev/null || true
          done

      # ğŸ›‘ 3) ä¿ç•™éŸ³ä¹æ–‡ä»¶åœ¨æ ¹ç›®å½•ï¼Œä¿æŠ¤æ’­æ”¾
      - name: Protect streaming audio files
        run: |
          echo "Keeping media at root: .m3u .mp3 .m4a .flac"

      # ğŸŸ¡ 4) å…¶ä»–ééŸ³ä¹ & éè„šæœ¬æ–‡ä»¶ â†’ å½’æ¡£ç›®å½• music GitHub
      - name: Move other non-media files to archive
        run: |
          mkdir -p "music GitHub"
          for f in $(find . -maxdepth 1 -type f ! -name "*.mp3" ! -name "*.m4a" ! -name "*.flac" ! -name "*.m3u" ! -name "*.yml" ! -name "*.md" ! -name "README" ! -name "DIRECTORY.md" ! -name ".nojekyll" ! -name ".gitattributes" ! -name ".mime.types" ! -name ".htaccess" ! -name "_config.yml" ! -name "index.html"); do
            git mv "$f" "music GitHub/" 2>/dev/null || true
          done

      # ğŸ“„ 5) è‡ªåŠ¨ç”Ÿæˆç›®å½•è¯´æ˜æ–‡æ¡£
      - name: Generate/Update DIRECTORY.md
        run: |
          cat << 'EOF' > DIRECTORY.md
          # Repository Directory Guide

          ## ğŸ“Œ Rules

          ### ğŸµ Music (root)
          | File Type | Reason |
          |-----------|--------|
          | `.mp3`, `.m4a`, `.flac` | Streaming links must remain stable |
          | `.m3u` | Playlist paths must not change |

          ### ğŸ–¥ Scripts
          Script-type extensions stay organized by prefix:

          | Prefix | Folder | Example |
          |--------|--------|---------|
          | `mac*` | `mac/` | mac_sysinfo.sh |
          | `vm*` | `vm/` | vm_setup.py |
          | `win*` | `win/` | win_clean.ps1 |

          ### ğŸ“¦ Archives & Resources
          | Folder | Content |
          |--------|---------|
          | `music GitHub/` | Resources, metadata, backups, misc |

          EOF

      # âœ” 6) æ£€æŸ¥å˜æ›´å†è‡ªåŠ¨æäº¤
      - name: Commit changes
        run: |
          if git diff --cached --quiet; then
            echo "No changes detected. Exiting."
            exit 0
          fi
          git commit -m "chore: auto-organize directory structure"

      # ğŸ¤– 7) åˆ›å»º PR å¹¶æ ‡è®°è‡ªåŠ¨åˆå¹¶
      - name: Create Auto-PR
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: auto-organize directory structure"
          title: "Auto-organized Repository Structure"
          body: "ğŸ¤– Automated update. Music safe. Scripts organized."
          branch: auto-organize-script
          labels: |
            automated
            automerge

      # ğŸ” 8) ä½¿ç”¨ GitHub åŸç”Ÿ API è‡ªåŠ¨åˆå¹¶
      - name: Enable Auto-Merge
        if: ${{ github.event_name != 'pull_request' }}
        run: |
          gh pr merge auto-organize-script --squash --auto
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
